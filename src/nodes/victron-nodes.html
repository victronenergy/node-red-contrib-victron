<link rel="stylesheet" href="resources/@victronenergy/node-red-contrib-victron/victron-styles.css">
<script src="resources/@victronenergy/node-red-contrib-victron/victron-common.js"></script>

<script type="text/template" id="input-edit-template">
    <div class="victron-form">
        <div class="form-info hidden" id="custominfo">
            Note that there is no guarantee that used services and paths will remain existent with firmware updates for custom nodes.
        </div>
        <div class="form-row" id="stored-settings">
            <div class="info-text">
            </div>
        </div>
        <div class="form-row" id="name-row">
            <label for="node-input-name"><i class="fa fa-tag"></i> Name <i class="fa fa-info-circle tooltip-icon" data-tooltip="The node can be given an arbitrary label that is shown instead of device name and service."></i></label>
            <input type="text" id="node-input-name" placeholder="Name">
        </div>
        <div class="form-row" id="service-row">
            <hr />
            <label for="node-input-service">Device</label>
            <select id="node-input-service"></select>
        </div>
        <div class="form-info hidden" id="duplicatesinfo"></div>
        <div class="form-row" id="path-row">
            <label for="node-input-path">Measurement</label>
            <select id="node-input-path"></select>
        </div>
        <div class="form-warning hidden" id="warningmessage"></div>
        <div class="form-warning hidden" id="statusmessage"></div>
        <div class="form-tips hidden" id="enuminfo">
            <p class="enuminfo--header">Value types</p>
            <p id="enuminfo-text"></p>
        </div>
        <div class="form-row" id="initial-row">
            <hr />
            <label for="node-input-initial"><i class="fa fa-upload"></i> Initial value <i class="fa fa-info-circle tooltip-icon" data-tooltip="The initial value is sent to the device whenever the node is deployed."></i></label>
            <div class="initial-value-container">
                <select id="node-input-initial-enum" class="initial-input"></select>
                <input type="number" id="node-input-initial-number" class="initial-input" placeholder="Initial" >
                <input type="text" id="node-input-initial-string" class="initial-input" placeholder="Initial">
            </div>
        </div>

        <!-- Output 1 Settings (for input nodes) -->
        <div class="form-row hidden" id="roundValues">
            <hr />
            <label for="node-input-roundValues"><i class="fa fa-minus-circle"></i> Rounding <i class="fa fa-info-circle tooltip-icon" data-tooltip="Round values to less digits."></i></label>
            <select id="node-input-roundValues">
                <option value="no">Do not round</option>
                <option value="0">Zero digits</option>
                <option value="1">1 digit</option>
                <option value="2">2 digits</option>
                <option value="3">3 digits</option>
            </select>
        </div>
        <div class="form-row hidden" id="onlyChanges">
            <label for="node-input-onlyChanges"><i class="fa fa-bell"></i> Only changes <i class="fa fa-info-circle tooltip-icon" data-tooltip="Only send output on (initially not rounded) value changes and not every 5 seconds."></i></label>
            <input type="checkbox" checked id="node-input-onlyChanges">
        </div>
        <div class="form-row hidden" id="rateLimit">
            <label for="node-input-rateLimit"><i class="fa fa-tachometer"></i> Rate limit <i class="fa fa-info-circle tooltip-icon" data-tooltip="Limit the maximum rate of messages. Useful for high-frequency measurements like grid meters. Most measurements don't need rate limiting."></i></label>
            <select id="node-input-rateLimit">
                <option value="0">No limit</option>
                <option value="10">10 msg/sec</option>
                <option value="5">5 msg/sec</option>
                <option value="2">2 msg/sec</option>
                <option value="1">1 msg/sec</option>
                <option value="0.5">1 msg per 2 sec</option>
                <option value="0.2">1 msg per 5 sec</option>
            </select>
        </div>

        <!-- Conditional Mode Section (Output 2) -->
        <div class="form-row" id="conditional-mode-toggle-row">
            <hr />
            <label for="node-input-conditionalMode">
                <i class="fa fa-filter"></i> Conditional Mode
                <i class="fa fa-info-circle tooltip-icon" data-tooltip="Enables a second output for conditional evaluation. Output 1 continues to send the raw measurement value (subject to rounding/rate limit settings above). Output 2 sends TRUE/FALSE based on conditions below."></i>
            </label>
            <input type="checkbox" id="node-input-conditionalMode">
        </div>

        <!-- Live Preview Panel -->
        <div id="conditional-preview-panel" class="victron-preview-panel hidden">
            <div class="victron-preview-header">
                <i class="fa fa-eye"></i> Live Preview
                <span class="victron-preview-status" id="preview-connection-status">
                    <i class="fa fa-circle-o-notch fa-spin"></i> Connecting...
                </span>
            </div>

            <div class="victron-preview-body" id="preview-body">
                <div class="victron-preview-placeholder">
                    Configure conditions to see live evaluation
                </div>
            </div>
        </div>

        <!-- Conditional Configuration Panel (hidden by default) -->
        <div id="conditional-config-panel" class="hidden">

            <!-- Primary Condition Section -->
            <div class="victron-condition-section">
                <div class="victron-condition-header">
                    <span class="victron-condition-badge">Condition 1</span>
                </div>

                <div class="form-row victron-condition-row">
                    <label for="node-input-condition1-operator">Operator</label>
                    <select id="node-input-condition1-operator" class="victron-operator-select">
                        <option value=">">&gt; (greater than)</option>
                        <option value=">=">&gt;= (greater or equal)</option>
                        <option value="<">&lt; (less than)</option>
                        <option value="<=">&lt;= (less or equal)</option>
                        <option value="==">== (equal to)</option>
                        <option value="!=">!= (not equal to)</option>
                    </select>
                </div>

                <div class="form-row victron-condition-row">
                    <label for="node-input-condition1-threshold">Threshold</label>
                    <input type="number" id="node-input-condition1-threshold" placeholder="e.g., 50" step="any" autocomplete="off" data-lpignore="true">
                </div>
            </div>

            <!-- Second Condition Toggle -->
            <div class="form-row victron-add-condition-row">
                <label>&nbsp;</label>
                <button type="button" id="add-condition-2-btn" class="victron-add-condition-btn">
                    <i class="fa fa-plus-circle"></i> Add second condition
                </button>
            </div>

            <!-- Second Condition Section (hidden by default) -->
            <div id="condition-2-panel" class="victron-condition-section hidden">
                <div class="victron-condition-header">
                    <span class="victron-condition-badge">Condition 2</span>
                    <button type="button" id="remove-condition-2-btn" class="victron-remove-condition-btn">
                        <i class="fa fa-times"></i>
                    </button>
                </div>

                <!-- Logic Operator (AND/OR) -->
                <div class="form-row victron-logic-row">
                    <label for="node-input-logicOperator">Combine with</label>
                    <div class="victron-logic-toggle">
                        <label class="victron-logic-option">
                            <input type="radio" name="logicOperator" value="AND" checked>
                            <span class="victron-logic-label">AND</span>
                        </label>
                        <label class="victron-logic-option">
                            <input type="radio" name="logicOperator" value="OR">
                            <span class="victron-logic-label">OR</span>
                        </label>
                    </div>
                </div>

                <div class="form-row victron-condition-row">
                    <label for="node-input-condition2-service">Service</label>
                    <select id="node-input-condition2-service" class="victron-condition-service">
                    </select>
                </div>

                <div class="form-row victron-condition-row">
                    <label for="node-input-condition2-path">Measurement</label>
                    <select id="node-input-condition2-path">
                    </select>
                </div>

                <div class="form-row victron-condition-row">
                    <label for="node-input-condition2-operator">Operator</label>
                    <select id="node-input-condition2-operator" class="victron-operator-select">
                        <option value=">">&gt; (greater than)</option>
                        <option value=">=">&gt;= (greater or equal)</option>
                        <option value="<">&lt; (less than)</option>
                        <option value="<=">&lt;= (less or equal)</option>
                        <option value="==">== (equal to)</option>
                        <option value="!=">!= (not equal to)</option>
                    </select>
                </div>

                <div class="form-row victron-condition-row">
                    <label for="node-input-condition2-threshold">Threshold</label>
                    <input type="number" id="node-input-condition2-threshold" placeholder="e.g., 90" step="any" autocomplete="off" data-lpignore="true">
                </div>
            </div>

            <!-- Output Configuration -->
            <div class="victron-output-config-section">
                <div class="form-row">
                    <hr />
                    <div class="victron-section-title">Output Configuration</div>
                </div>

                <div class="form-row">
                    <label for="node-input-outputTrue">
                        Output when TRUE
                        <i class="fa fa-info-circle tooltip-icon" data-tooltip="Value to send when conditions evaluate to true. Can be JSON (e.g., {&quot;state&quot;:&quot;on&quot;}) or a literal value."></i>
                    </label>
                    <input type="text" id="node-input-outputTrue" placeholder='true or {"state":"on"}' autocomplete="off" data-lpignore="true">
                </div>

                <div class="form-row">
                    <label for="node-input-outputFalse">
                        Output when FALSE
                        <i class="fa fa-info-circle tooltip-icon" data-tooltip="Value to send when conditions evaluate to false. Can be JSON or a literal value."></i>
                    </label>
                    <input type="text" id="node-input-outputFalse" placeholder='false or {"state":"off"}' autocomplete="off" data-lpignore="true">
                </div>

                <div class="form-row">
                    <label for="node-input-debounce">
                        <i class="fa fa-clock-o"></i> Debounce (ms)
                        <i class="fa fa-info-circle tooltip-icon" data-tooltip="Delay in milliseconds before sending output. Prevents rapid changes from triggering multiple outputs. Use 0 for no debounce."></i>
                    </label>
                    <input type="number" id="node-input-debounce" placeholder="0" min="0" step="100" value="0" autocomplete="off" data-lpignore="true">
                </div>
            </div>
        </div>

        <div class="victron-doc-box hidden" id="outputinfo">
            <div class="victron-doc-text">
                <strong>Usage:</strong>
                <div>The value for the controlled output should be set in the incoming message's <code>msg.payload</code> property.</div>
                <div>If specific value types are shown above, use those values.</div>
            </div>
        </div>
        <div class="form-row community-link-row hidden" id="community-link-row">
            <div class="community-link-container">
                <a id="community-link" href="#" target="_blank" rel="noopener noreferrer">
                    <img class="community-link-img" src="resources/@victronenergy/node-red-contrib-victron/docs/community-link.svg" alt="Community Link">
                </a>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
    // Polyfills. Mainly for IE.

    if (!Array.prototype.find) {
        Array.prototype.find = function(predicate) {
            if (this == null) {
                throw new TypeError('Array.prototype.find called on null or undefined');
            }
            if (typeof predicate !== 'function') {
                throw new TypeError('predicate must be a function');
            }
            var list = Object(this);
            var length = list.length >>> 0;
            var thisArg = arguments[1];
            var value;

            for (var i = 0; i < length; i++) {
                value = list[i];
                if (predicate.call(thisArg, value, i, list)) {
                    return value;
                }
            }
            return undefined;
        };
    }

    if (!Object.entries) {
        Object.entries = function (obj) {
            var ownProps = Object.keys(obj),
                i = ownProps.length,
                resArray = new Array(i);
            while (i--)
                resArray[i] = [ownProps[i], obj[ownProps[i]]];

            return resArray;
    };
}

</script>

<script type="text/javascript">
    "use strict";

    var serviceRoot = (RED.settings.httpNodeRoot || RED.settings.httpAdminRoot || "").replace(/\/$/, "") + '/victron/services/';

    function initializeConditionalMode(node) {
        var $conditionalMode = $('#node-input-conditionalMode');
        var $conditionalPanel = $('#conditional-config-panel');
        var $condition2Panel = $('#condition-2-panel');
        var $addCondition2Btn = $('#add-condition-2-btn');
        var $removeCondition2Btn = $('#remove-condition-2-btn');
        var $condition2Service = $('#node-input-condition2-service');
        var $condition2Path = $('#node-input-condition2-path');

        // Fetch and populate condition 2 service dropdown
        function populateCondition2Services() {
            $.ajax(serviceRoot, {
                beforeSend: function(jqXHR) {
                    var auth_tokens = RED.settings.get("auth-tokens");
                    if (auth_tokens) {
                        jqXHR.setRequestHeader("Authorization", "Bearer " + auth_tokens.access_token);
                    }
                }
            }).done(function(allServices) {
                // Combine all input services into a single array
                var serviceMap = {};
                Object.keys(allServices).forEach(function(key) {
                    if (key.startsWith('input-') && key !== 'input-custom' && allServices[key].services) {
                        allServices[key].services.forEach(function(service) {
                            if (service.service) {
                                var dedupeKey = service.service + ':' + (service.deviceInstance || '');
                                serviceMap[dedupeKey] = service;
                            }
                        });
                    }
                });

                var services = Object.values(serviceMap);

                // Apply blacklist filter
                if (window.__victronCommon && window.__victronCommon.filterBlacklistedServices) {
                    services = window.__victronCommon.filterBlacklistedServices(services);
                }

                // Build grouped dropdown with optgroups
                if (window.__victronCommon && window.__victronCommon.buildGroupedServiceDropdown) {
                    try {
                        window.__victronCommon.buildGroupedServiceDropdown(services, $condition2Service);
                    } catch (error) {
                        console.error('Error building grouped dropdown:', error);
                        // Fallback to old method
                        var serviceCounts = window.__victronCommon.countServicesByName(services);
                        $condition2Service.empty();
                        services.forEach(function(service) {
                            var optionText = service.name;
                            var shouldShowInstance = serviceCounts[service.name] > 1;
                            if (shouldShowInstance && service.deviceInstance && !optionText.includes('(' + service.deviceInstance + ')')) {
                                optionText += ' (' + service.deviceInstance + ')';
                            }
                            var $option = $('<option/>')
                                .val(service.service)
                                .text(optionText)
                                .data(service);
                            $condition2Service.append($option);
                        });
                    }
                } else {
                    // Fallback if function not available
                    var serviceCounts = window.__victronCommon.countServicesByName(services);
                    $condition2Service.empty();
                    services.forEach(function(service) {
                        var optionText = service.name;
                        var shouldShowInstance = serviceCounts[service.name] > 1;
                        if (shouldShowInstance && service.deviceInstance && !optionText.includes('(' + service.deviceInstance + ')')) {
                            optionText += ' (' + service.deviceInstance + ')';
                        }
                        var $option = $('<option/>')
                            .val(service.service)
                            .text(optionText)
                            .data(service);
                        $condition2Service.append($option);
                    });
                }

                // Restore saved selection if exists, or populate paths for first service
                if (node.condition2Service) {
                    $condition2Service.val(node.condition2Service);
                }
                // Always update paths after populating services (for both saved and new selections)
                updateCondition2Paths();
            });
        }

        // Update condition 2 paths based on selected service
        function updateCondition2Paths() {
            var serviceData = $condition2Service.find(':selected').data();
            if (serviceData && serviceData.paths) {
                var paths = serviceData.paths;

                // Filter to numeric types only
                if (window.__victronCommon && window.__victronCommon.filterNumericPaths) {
                    paths = window.__victronCommon.filterNumericPaths(paths);
                }

                // Populate path dropdown
                $condition2Path.empty();
                paths.forEach(function(path) {
                    var option = $('<option/>')
                        .val(path.path)
                        .text(path.name)
                        .data(path);
                    $condition2Path.append(option);
                });

                // Restore saved path selection
                if (node.condition2Path) {
                    $condition2Path.val(node.condition2Path);
                }
            }
        }

        // Handle service selection change
        $condition2Service.on('change', updateCondition2Paths);

        // Load services for condition 2
        populateCondition2Services();

        // Restore saved conditional mode state
        if (node.conditionalMode) {
            $conditionalMode.prop('checked', true);
            $conditionalPanel.show();
            $('#conditional-mode-info').show();

            // Restore condition 1 values
            if (node.condition1Operator) $('#node-input-condition1-operator').val(node.condition1Operator);
            if (node.condition1Threshold !== undefined) $('#node-input-condition1-threshold').val(node.condition1Threshold);

            // Restore condition 2 if enabled
            if (node.condition2Enabled) {
                $condition2Panel.removeClass('hidden').show();
                $addCondition2Btn.parent().hide();

                // Restore condition 2 service and path
                if (node.condition2Service) {
                    $condition2Service.val(node.condition2Service);
                    updateCondition2Paths(); // This will populate paths for the selected service
                }
                if (node.condition2Path) {
                    // Set path after a small delay to ensure paths are loaded
                    setTimeout(function() {
                        $condition2Path.val(node.condition2Path);
                    }, 100);
                }

                if (node.condition2Operator) $('#node-input-condition2-operator').val(node.condition2Operator);
                if (node.condition2Threshold !== undefined) $('#node-input-condition2-threshold').val(node.condition2Threshold);
                if (node.logicOperator) $('input[name="logicOperator"][value="' + node.logicOperator + '"]').prop('checked', true);
            }

            // Restore output configuration
            if (node.outputTrue !== undefined) $('#node-input-outputTrue').val(node.outputTrue);
            if (node.outputFalse !== undefined) $('#node-input-outputFalse').val(node.outputFalse);
            // outputOnChange is now always enforced to true in the backend for conditional mode
            if (node.debounce !== undefined) $('#node-input-debounce').val(node.debounce);
        }

        // Toggle conditional mode panel
        $conditionalMode.on('change', function() {
            if ($(this).is(':checked')) {
                $conditionalPanel.slideDown(200);
                $('#conditional-mode-info').slideDown(200);
            } else {
                $conditionalPanel.slideUp(200);
                $('#conditional-mode-info').slideUp(200);
            }
        });

        // Add second condition
        $addCondition2Btn.on('click', function() {
            $condition2Panel.removeClass('hidden').slideDown(200);
            $(this).parent().hide();
            updateLivePreview(); // Update preview when condition 2 is added
        });

        // Remove second condition
        $removeCondition2Btn.on('click', function() {
            $condition2Panel.slideUp(200, function() {
                $condition2Panel.addClass('hidden');
                $addCondition2Btn.parent().show();
                // Clear condition 2 values
                $condition2Service.val('');
                $condition2Path.val('');
                $('#node-input-condition2-operator').val('>');
                $('#node-input-condition2-threshold').val('');
                $('input[name="logicOperator"][value="AND"]').prop('checked', true);
                updateLivePreview(); // Re-render preview to reflect removal of condition 2
            });
        });

        // Live preview state
        var previewCache = {};
        var $previewPanel = $('#conditional-preview-panel');
        var $previewBody = $('#preview-body');
        var $previewStatus = $('#preview-connection-status');

        // Update preview when operator/threshold changes (no data fetch needed)
        $('#node-input-condition1-operator, #node-input-condition1-threshold, ' +
          '#node-input-condition2-operator, #node-input-condition2-threshold, ' +
          'input[name="logicOperator"]').on('change input', function() {
            updateLivePreview();
        });

        // Start preview and fetch initial data when conditional mode is enabled
        $conditionalMode.on('change', function() {
            if ($(this).is(':checked')) {
                setTimeout(function() {
                    startLivePreview();
                }, 100);
            } else {
                stopLivePreview();
            }
        });

        // Fetch new data when a service or path is changed
        $('#node-input-service, #node-input-path, #node-input-condition2-service, #node-input-condition2-path').on('change', function() {
            if ($conditionalMode.is(':checked')) {
                fetchPreviewCache();
            }
        });

        function evaluateCondition(currentValue, operator, threshold) {
            if (currentValue === null || currentValue === undefined || isNaN(currentValue)) {
                return null;
            }
            var current = Number(currentValue);
            var thresholdNum = Number(threshold);
            if (isNaN(thresholdNum)) return null;

            var getEpsilon = function(a, b) {
                var absMax = Math.max(Math.abs(a), Math.abs(b));
                return absMax === 0 ? 1e-10 : absMax * 1e-10;
            };

            switch (operator) {
                case '>': return current > thresholdNum;
                case '>=': return current >= thresholdNum;
                case '<': return current < thresholdNum;
                case '<=': return current <= thresholdNum;
                case '==': return Math.abs(current - thresholdNum) < getEpsilon(current, thresholdNum);
                case '!=': return Math.abs(current - thresholdNum) >= getEpsilon(current, thresholdNum);
                default: return null;
            }
        }

        function fetchPreviewCache() {
            $previewStatus.html('<i class="fa fa-circle-o-notch fa-spin"></i>');
            var cacheUrl = (RED.settings.httpNodeRoot || RED.settings.httpAdminRoot || "").replace(/\/$/, "") + '/victron/cache';
            $.ajax({
                url: cacheUrl,
                type: "GET",
                beforeSend: function(jqXHR) {
                    var auth_tokens = RED.settings.get("auth-tokens");
                    if (auth_tokens) {
                        jqXHR.setRequestHeader("Authorization", "Bearer " + auth_tokens.access_token);
                    }
                },
                dataType: 'text' // Expect text to parse JSON manually
            }).done(function(data) {
                try {
                    previewCache = JSON.parse(data);
                    $previewStatus.html('<i class="fa fa-check-circle"></i>');
                } catch(e) {
                    previewCache = {};
                    $previewStatus.html('<i class="fa fa-times-circle tooltip-icon" data-tooltip="Cache Parse Error"></i>');
                }
                updateLivePreview();
            }).fail(function() {
                previewCache = {};
                $previewStatus.html('<i class="fa fa-times-circle tooltip-icon" data-tooltip="Cache Fetch Error"></i>');
                updateLivePreview();
            });
            // Re-initialize tooltips for newly added/modified elements
            if (window.__victronCommon && window.__victronCommon.initializeTooltips) {
                window.__victronCommon.initializeTooltips();
            }
        }

        // Helper function to format numbers intelligently (max 3 decimals, no trailing zeros)
        function formatPreviewNumber(value) {
            if (value === null || value === undefined) return '--';
            if (typeof value !== 'number') return value;

            // Round to max 3 decimals and remove trailing zeros
            var rounded = Math.round(value * 1000) / 1000;

            // Convert to string and remove trailing zeros after decimal
            var str = rounded.toString();
            if (str.indexOf('.') !== -1) {
                str = str.replace(/\.?0+$/, '');
            }

            return str;
        }

        function updateLivePreview() {
            var primaryService = $('#node-input-service').val();
            var primaryPath = $('#node-input-path').val();
            var condition1Operator = $('#node-input-condition1-operator').val();
            var condition1Threshold = $('#node-input-condition1-threshold').val();

            if (!primaryService || !primaryPath || !condition1Operator || condition1Threshold === '') {
                $previewBody.html('<div class="victron-preview-placeholder">Configure conditions to see live evaluation</div>');
                return;
            }

            var condition1Value = (previewCache[primaryService] && previewCache[primaryService][primaryPath] !== undefined)
                ? previewCache[primaryService][primaryPath]
                : null;

            var result1 = evaluateCondition(condition1Value, condition1Operator, condition1Threshold);

            var html = '<div class="victron-preview-line">';

            // Condition 1
            var c1Class = result1 === null ? '' : (result1 ? 'true' : 'false');
            var c1ValText = formatPreviewNumber(condition1Value);
            html += '<span class="victron-preview-group ' + c1Class + '">';
            html += '(<span id="preview-val-1">' + c1ValText + '</span> ' + condition1Operator + ' ' + condition1Threshold + ')';
            html += '</span>';

            var finalResult = result1;

            // Condition 2 (if enabled and configured)
            if ($condition2Panel.is(':visible')) {
                var condition2Service = $condition2Service.val();
                var condition2Path = $condition2Path.val();
                var condition2Operator = $('#node-input-condition2-operator').val();
                var condition2Threshold = $('#node-input-condition2-threshold').val();
                var logicOperator = $('input[name="logicOperator"]:checked').val();

                html += '<span class="victron-preview-logic-op">' + logicOperator + '</span>';

                if (condition2Service && condition2Path && condition2Operator && condition2Threshold !== '') {
                    var condition2Value = (previewCache[condition2Service] && previewCache[condition2Service][condition2Path] !== undefined)
                        ? previewCache[condition2Service][condition2Path]
                        : null;
                    var result2 = evaluateCondition(condition2Value, condition2Operator, condition2Threshold);

                    var c2Class = result2 === null ? '' : (result2 ? 'true' : 'false');
                    var c2ValText = formatPreviewNumber(condition2Value);
                    html += '<span class="victron-preview-group ' + c2Class + '">';
                    html += '(<span id="preview-val-2">' + c2ValText + '</span> ' + condition2Operator + ' ' + condition2Threshold + ')';
                    html += '</span>';

                    if (result1 !== null && result2 !== null) {
                        finalResult = logicOperator === 'AND' ? (result1 && result2) : (result1 || result2);
                    } else {
                        finalResult = null;
                    }
                } else {
                    html += '<span class="victron-preview-group">(--)</span>';
                    finalResult = null;
                }
            }

            // Final Result
            html += '<span class="victron-preview-equals">=</span>';
            var finalResultClass = finalResult === null ? '' : (finalResult ? 'true' : 'false');
            var finalResultIcon = finalResult === null ? '' : (finalResult ? '<i class="fa fa-check-circle"></i> ' : '<i class="fa fa-times-circle"></i> ');
            var finalResultText = finalResult === null ? '--' : (finalResult ? 'TRUE' : 'FALSE');

            html += '<span class="victron-preview-final-result ' + finalResultClass + '">' + finalResultIcon + finalResultText + '</span>';

            html += '</div>'; // Close .victron-preview-line
            $previewBody.html(html);
        }

        function startLivePreview() {
            $previewPanel.removeClass('hidden');
            fetchPreviewCache(); // Initial fetch
        }

        function stopLivePreview() {
            $previewPanel.addClass('hidden');
        }

        // Start preview if conditional mode is already enabled
        if (node.conditionalMode) {
            setTimeout(function() {
                if ($conditionalMode.is(':checked')) {
                    startLivePreview();
                }
            }, 500);
        }

        // Clean up on dialog close
        return function cleanup() {
            stopLivePreview();
        };
    }

    function buildEditPanel(node, service, isOutputNode, isCustomNode, nodeLabel) {
        var serviceElem = $('#node-input-service');
        var pathElem = $('#node-input-path');
        var initialValueElem = $('#node-input-initial');
        var serviceDataAvailable = null;
        var nodeLabelLower = nodeLabel.toLowerCase();
        var serviceUrl = isOutputNode ? 'output-' + service : 'input-' + service;

        var buildOption = function buildOption(service) {
            var optionText = service.name;

            if (service.deviceInstance && !optionText.includes(`(${service.deviceInstance})`)) {
                optionText += ` (${service.deviceInstance})`;
            }

            if (service.value === null) {
                optionText += " - (null)";
            }

            var option = $('<option/>')
                .val(service.service || service.path)
                .text(optionText)
                .data(service);

            return option
        };

        var populateSelect = function populateSelect(selector, services) {
            selector[0].options.length = 0;
            services.forEach(function (service) {
                selector.append(buildOption(service));
            });
            selector.trigger('change');
        };

        var updatePaths = function updatePaths() {
            var serviceData = serviceElem.find(':selected').data();
            if (serviceData && serviceData.paths) populateSelect(pathElem, serviceData.paths);
            pathElem.val($('#selectedpath').text());
            // Show/hide status message based on whether the disconnected service is selected
            if (serviceElem.val() === node.service && serviceElem.find(':selected').text().includes('[disconnected]')) {
                $('#statusmessage').show();
            } else {
                $('#statusmessage').hide();
            }
            updateEnums();
            updateCommunityLink();
        };

        var communityTag = null;  // Store communityTag at module level

        var updateCommunityLink = function updateCommunityLink() {
            if (communityTag) {
                // Currently all nodes link to the general Node-RED community page
                // In the future, communityTag could be appended to create device-specific links
                var url = 'https://community.victronenergy.com/c/node-red/28/'; // + communityTag;
                $('#community-link').attr('href', url);
                $('#community-link-row').show();
            } else {
                $('#community-link-row').hide();
            }
        };

        var updateEnums = function updateEnums() {
            var pathData = pathElem.find(':selected').data();

            if (pathData) {
                pathData.warning && serviceDataAvailable ?
                    changeStatusText($('#warningmessage'), 'fa-exclamation-circle', pathData.warning) :
                    $('#warningmessage').hide();
            }

            // Hide all initial value inputs first
            $('.initial-input').hide();
            hideEnumInfo();

            if (pathData) {
                $('#initial-row').hide();

                // Show appropriate input based on path type
                switch(pathData.type) {
                    case 'enum':
                        var valueTypesEnum = pathData.enum;
                        showEnumInfo(valueTypesEnum);
                        var selectOptions = Object.keys(valueTypesEnum).map(function(key) {
                            return {
                                service: key,
                                name: `${key} - ${valueTypesEnum[key]}`
                            };
                        });
                        selectOptions.unshift({
                            service: null,
                            name: "Don't set initial value"
                        });

                        var enumInput = $('#node-input-initial-enum');
                        populateSelect(enumInput, selectOptions);
                        enumInput.show();
                        if (node.initial !== undefined && node.initial !== null) enumInput.val(node.initial);
                        break;

                    case 'float':
                    case 'integer':
                        var numberInput = $('#node-input-initial-number');
                        numberInput.show();
                        if (pathData.type === 'integer') {
                            numberInput.attr('step', '1');
                        } else {
                            numberInput.attr('step', 'any');
                        }
                        if (node.initial !== undefined && node.initial !== null) numberInput.val(node.initial);
                        break;

                    case 'string':
                        var stringInput = $('#node-input-initial-string');
                        stringInput.show();
                        if (node.initial !== undefined && node.initial !== null) stringInput.val(node.initial);
                        break;

                    default:
                        $('#initial-row').hide();
                }
                if (isOutputNode && !isCustomNode) {
                    $('#initial-row').show();
                }
            } else {
                $('#initial-row').hide();
            }

            if (typeof pathData !== 'undefined' &&
                (pathData.type === 'float' || pathData.type === 'number') &&
                !isOutputNode) {
                $('#roundValues').show();
            } else {
                $('#roundValues').hide();
            }
        };

        var showStatusMessage = function showStatusMessage(msg) {
            serviceElem.attr('disabled', 'disabled');
            pathElem.attr('disabled', 'disabled');
            initialValueElem.attr('disabled', 'disabled');
            changeStatusText($('#statusmessage'), 'fa-exclamation-circle', msg);
        };

        var changeStatusText = function changeStatusText(selector, iconClass, message) {
            // fa-info-circle fa-exclamation-circle
            selector.html("<i class=\"fa ".concat(iconClass, " fa-2x\"></i><i>").concat(message, "</i>")).show();
        };

        var showEnumInfo = function showEnumInfo(enumObj) {
            var msg = Object.entries(enumObj).map(function (item, key) {
                return "".concat(item[0], " - ").concat(item[1]);
            }).join('<br/>');
            $('#enuminfo-text').html(msg);
            $('#enuminfo').show();
        };

        var hideEnumInfo = function hideEnumInfo() {
            $('#enuminfo').hide();
        };

        /*  If a node was previously deployed, update the edit based on the old data */
        var appendSavedService = function appendSavedService(data) {
            if (node.service) {
                // if the service not present anymore, still add it to the select list
                if (!data.find(function (s) {
                    return s.service === node.service;
                })) {
                    buildOption(node.serviceObj).text(node.serviceObj.name + " [disconnected]").appendTo(serviceElem);
                    changeStatusText($('#statusmessage'), 'fa-exclamation-circle', "The device is no longer available via the stored service path. Please (re)select the device from the dropdown and deploy again.");
                }

                if (node.serviceObj && node.pathObj) {
                    $('#stored-settings').html('<div class="stored-settings-display"><i class="fa fa-save stored-settings-icon"></i>Stored: '+node.serviceObj.name+' &gt; '+node.pathObj.name+'</div><div class="hidden" id="selectedpath">'+node.pathObj.path+'</div>')
                }
                serviceElem.val(node.service);
            }
        };

        if (isCustomNode) {
            $('#custominfo').show()
        } else {
            $('#custominfo').hide()
        }

        // Upon receiving data, populate the edit form
        $.ajax(serviceRoot + serviceUrl, {
            beforeSend: function(jqXHR) {
                var auth_tokens = RED.settings.get("auth-tokens");
                if (auth_tokens) {
                    jqXHR.setRequestHeader("Authorization","Bearer "+auth_tokens.access_token);
                }
            }
        })
        .done(response => {
            communityTag = response.communityTag;
            var data = response.services || [];
            serviceDataAvailable = data.length;

            // in case any services are available, populate the service and path dropdowns
            if (data.length !== 0) {
                if (isCustomNode && isOutputNode) {
                    data = data.filter(function (s) {
                        return s.service !== 'com.victronenergy.system/0';
                    });
                }

                populateSelect(serviceElem, data);

                function containsDuplicates(array) {
                    return array.sort().some(function (item, i, items) {
                        return item === items[i + 1];
                    });
                }

                // check for duplicate options in order to show an info message on setting a custom name
                var hasDuplicateNames = containsDuplicates(data.map(function (s) {
                    return s.name;
                }));

                if (hasDuplicateNames) {
                    var msg = "Multiple ".concat(nodeLabelLower, "s were found with the same name. You can set a custom name for the device in Venus settings.");
                    changeStatusText($('#duplicatesinfo'), 'fa-info-circle', msg);
                }
            } else { // otherwise, disable inputs and show a pretty statusmessage
                node.serviceObj ? showStatusMessage("There are no ".concat(nodeLabelLower, " services available. Please check that the selected ").concat(node.serviceObj.name, " is properly connected.")) : showStatusMessage("There are no ".concat(nodeLabelLower, " services available. Please check that a ").concat(nodeLabelLower, " is connected or try a different node."));
            }

            // append old service data, if we have a service and path saved to the node
            appendSavedService(data);

            // a change on serviceElem dropdown triggers updatePaths()
            // which renders new options for the selected service
            updatePaths();
            serviceElem.change(updatePaths);
            if (node.path) pathElem.val(node.path);

            // a change on pathElem dropdown triggers updateEnums()
            // which renders the enum value info box on demand
            updateEnums();
            pathElem.change(updateEnums); // show the information text on using 'msg.payload' to trigger settings for output nodes

            if (isOutputNode) {
                $('#outputinfo').show()
            } else {
                if (typeof(node.onlyChanges) === 'undefined') {
                    $('#node-input-onlyChanges').removeAttr("checked");
                }
                $('#onlyChanges').show()
                $('#rateLimit').show()
            }

            // Initialize tooltips
            if (window.__victronCommon && window.__victronCommon.initializeTooltips) {
                window.__victronCommon.initializeTooltips();
            }

            // Initialize conditional mode for input nodes only
            if (!isOutputNode) {
                node._conditionalModeCleanup = initializeConditionalMode(node);
            }

            updateCommunityLink();
        }).fail(function (jqXHR, textStatus, errorThrown) {
            $('#initial-row').hide();
            if (jqXHR.status === 503) {
                return showStatusMessage("Please deploy the flow once and re-open this edit panel.");
            } else if (jqXHR.status === 0) {
                return showStatusMessage("Unable to connect to Node-RED service endpoint. Check your network connection.");
            } else {
                return showStatusMessage("Unable to access the service endpoint: " + serviceRoot + serviceUrl + " (Status: " + jqXHR.status + " - " + errorThrown + ")");
            }
        });
    }

    function saveEditPanel(node) {
        // save the current service and path objects
        node.serviceObj = $('#node-input-service').find(':selected').data();
        if (node.serviceObj) {
            delete(node.serviceObj.paths);
            delete(node.serviceObj.deviceInstance);
        }
        node.pathObj = $('#node-input-path').find(':selected').data();

        // Determine if this is an output node based on the node type
        const isOutputNode = node.type.includes('-output-');

        // Save conditional mode configuration for input nodes
        if (!isOutputNode) {
            node.conditionalMode = $('#node-input-conditionalMode').is(':checked');

            if (node.conditionalMode) {
                // Condition 1
                node.condition1Operator = $('#node-input-condition1-operator').val();
                node.condition1Threshold = parseFloat($('#node-input-condition1-threshold').val());

                // Condition 2
                node.condition2Enabled = $('#condition-2-panel').is(':visible');
                if (node.condition2Enabled) {
                    node.condition2Service = $('#node-input-condition2-service').val();
                    node.condition2Path = $('#node-input-condition2-path').val();
                    node.condition2Operator = $('#node-input-condition2-operator').val();
                    node.condition2Threshold = parseFloat($('#node-input-condition2-threshold').val());
                    node.logicOperator = $('input[name="logicOperator"]:checked').val();

                    // Save condition 2 service and path objects
                    node.condition2ServiceObj = $('#node-input-condition2-service').find(':selected').data();
                    if (node.condition2ServiceObj) {
                        delete(node.condition2ServiceObj.paths);
                        delete(node.condition2ServiceObj.deviceInstance);
                    }
                    node.condition2PathObj = $('#node-input-condition2-path').find(':selected').data();
                } else {
                    // Clear condition 2 data if disabled
                    delete node.condition2Service;
                    delete node.condition2Path;
                    delete node.condition2Operator;
                    delete node.condition2Threshold;
                    delete node.logicOperator;
                    delete node.condition2ServiceObj;
                    delete node.condition2PathObj;
                }

                // Output configuration
                node.outputTrue = $('#node-input-outputTrue').val();
                node.outputFalse = $('#node-input-outputFalse').val();
                // outputOnChange is always enforced to true in the backend for conditional mode
                node.debounce = parseInt($('#node-input-debounce').val()) || 0;
            } else {
                // Clear all conditional mode data if disabled
                delete node.condition1Operator;
                delete node.condition1Threshold;
                delete node.condition2Enabled;
                delete node.condition2Service;
                delete node.condition2Path;
                delete node.condition2Operator;
                delete node.condition2Threshold;
                delete node.logicOperator;
                delete node.condition2ServiceObj;
                delete node.condition2PathObj;
                delete node.outputTrue;
                delete node.outputFalse;
                delete node.outputOnChange;
                delete node.debounce;
            }

            // Update outputs count based on conditional mode
            node.outputs = node.conditionalMode ? 2 : 1;
        }

        // Only try to save initial value if we have path data and it's an output node
        if (node.pathObj && isOutputNode) {
            // Clear initial value by default
            node.initial = undefined;

            switch(node.pathObj.type) {
                case 'enum':
                    var selectedValue = $('#node-input-initial-enum').val();
                    // Only save if a real value is selected (not the "Don't set" option)
                    if (selectedValue !== null && selectedValue !== '') {
                        node.initial = parseInt(selectedValue);
                    }
                    break;

                case 'float':
                case 'integer':
                    var value = $('#node-input-initial-number').val().trim();
                    if (value !== '') {
                        var numValue = node.pathObj.type === 'integer' ?
                            parseInt(value) : parseFloat(value);
                        if (!isNaN(numValue)) {
                            node.initial = numValue;
                        }
                    }
                    break;

                case 'string':
                    var value = $('#node-input-initial-string').val().trim();
                    if (value !== '') {
                        node.initial = value;
                    }
                    break;
            }
        }
    }

    function buildNodeLabel(node, nodeName) {
        var altName = nodeName;

        if (node.serviceObj && node.path) {
            var svc = node.serviceObj.name;
            var path = node.pathObj.name;
            altName = "".concat(svc, " | ").concat(path);
        }

        return node.name || altName;
    }

    // Builds the edit panel form dynamically for each input node
    function buildEditForm(nodeType, serviceName) {
        // Clone the edit form template
        var editForm = $("#input-edit-template").clone().html();
        var scriptTag = $("<script>").attr("type", "text/x-red").attr("data-template-name", nodeType).append(editForm); // Edit template data

        scriptTag.find('#service-row > label').text(serviceName); // Append to the document body

        $('body').append(scriptTag.prop('outerHTML'));
    }

    // Creates an input-node config and registers it with
    // the Node-RED Node API
    function registerNode(nodeType, nodeLabel, serviceType, isOutputNode, isCustomNode) {
        // Copy the edit form template to the html body
        buildEditForm(nodeType, nodeLabel);
        var nodePaletteLabel = isOutputNode ? nodeLabel + ' Control' : nodeLabel;

        RED.nodes.registerType(nodeType, {
            category: 'Victron Energy',
            paletteLabel: nodePaletteLabel,
            defaults: {
                service: { value: "", required: true },
                path: { value: "", required: true },
                serviceObj: { value: undefined },
                pathObj: { value: undefined },
                initial: { value: undefined },
                name: { value: "" },
                "onlyChanges": { value: false },
                "roundValues": { value: "no" },
                "rateLimit": { value: 0 },
                outputs: { value: 1 },
                // Conditional mode properties
                conditionalMode: { value: false },
                condition1Operator: { value: ">" },
                condition1Threshold: { value: undefined },
                condition2Enabled: { value: false },
                condition2Service: { value: "" },
                condition2Path: { value: "" },
                condition2ServiceObj: { value: undefined },
                condition2PathObj: { value: undefined },
                condition2Operator: { value: ">" },
                condition2Threshold: { value: undefined },
                logicOperator: { value: "AND" },
                outputTrue: { value: "true" },
                outputFalse: { value: "false" },
                outputOnChange: { value: false },
                debounce: { value: 0 }
            },
            color: isCustomNode ? "#f7ab3e" : "#4790d0",
            inputs: isOutputNode ? 1 : 0,
            outputs: isOutputNode ? 0 : 1,
            outputLabels: isOutputNode ? undefined : function(index) {
                if (!this.conditionalMode) return undefined;
                return index === 0 ? "value" : "conditional";
            },
            icon: "victronenergy.svg",
            label: function label() {
                return buildNodeLabel(this, nodePaletteLabel);
            },
            oneditprepare: function oneditprepare() {
                buildEditPanel(this, serviceType, isOutputNode, isCustomNode, nodeLabel);
            },
            oneditsave: function oneditsave() {
                saveEditPanel(this);
                if (this._conditionalModeCleanup) {
                    this._conditionalModeCleanup();
                    delete this._conditionalModeCleanup;
                }
            },
            oneditcancel: function oneditcancel() {
                if (this._conditionalModeCleanup) {
                    this._conditionalModeCleanup();
                    delete this._conditionalModeCleanup;
                }
            },
            onadd: function() {
                let hasClient = false
                RED.nodes.eachConfig(function (n) {
                    if (n.id === 'victron-client-id')
                        hasClient = true
                });

                if ( !hasClient ) {
                    var victronClientNode = {
                        id: "victron-client-id",
                        _def: RED.nodes.getType("victron-client"),
                        type: "victron-client",
                        users: [],
                        "showValues": true,
                        "contextStore": true,
                        valid: true
                    };
                    RED.nodes.add(victronClientNode);
                    RED.nodes.dirty(true);
                }
            }
        });
    }

    function registerInputNode(nodeType, nodeLabel, serviceType) {
        registerNode(nodeType, nodeLabel, serviceType, false, false);
    }

    function registerOutputNode(nodeType, nodeLabel, serviceType) {
        registerNode(nodeType, nodeLabel, serviceType, true, false);
    }

    registerInputNode('victron-input-accharger', 'AC Charger', 'accharger');
    registerInputNode('victron-input-acload', 'AC Load', 'acload');
    registerInputNode('victron-input-acsystem', 'AC System', 'acsystem');
    registerInputNode('victron-input-alternator', 'Alternator', 'alternator');
    registerInputNode('victron-input-battery', 'Battery Monitor', 'battery');
    registerInputNode('victron-input-dcdc', 'DC-DC', 'dcdc');
    registerInputNode('victron-input-dcload', 'DC Load', 'dcload');
    registerInputNode('victron-input-dcsource', 'DC Source', 'dcsource');
    registerInputNode('victron-input-dcsystem', 'DC System', 'dcsystem');
    registerInputNode('victron-input-dess', 'Dynamic ESS', 'dess');
    registerInputNode('victron-input-digitalinput', 'Digital Input', 'digitalinput');
    registerInputNode('victron-input-ess', 'ESS', 'ess');
    registerInputNode('victron-input-evcharger', 'EV Charger', 'evcharger');
    registerInputNode('victron-input-fuelcell', 'Fuel cell', 'fuelcell');
    registerInputNode('victron-input-generator', 'Generator', 'generator');
    registerInputNode('victron-input-gps', 'GPS', 'gps');
    registerInputNode('victron-input-gridmeter', 'Grid Meter', 'gridmeter');
    registerInputNode('victron-input-inverter', 'Inverter', 'inverter');
    registerInputNode('victron-input-meteo', 'Meteo', 'meteo');
    registerInputNode('victron-input-motordrive', 'E-drive', 'motordrive');
    registerInputNode('victron-input-multi', 'Multi RS', 'multi');
    registerInputNode('victron-input-pulsemeter', 'Pulsemeter', 'pulsemeter');
    registerInputNode('victron-input-pump', 'Pump', 'pump');
    registerInputNode('victron-input-pvinverter', 'PV Inverter', 'pvinverter');
    registerInputNode('victron-input-relay', 'Relay', 'relay');
    registerInputNode('victron-input-settings', 'Settings', 'settings');
    registerInputNode('victron-input-solarcharger', 'Solar Charger', 'solarcharger');
    registerInputNode('victron-input-switch', 'Switch', 'switch');
    registerInputNode('victron-input-system', 'System', 'system');
    registerInputNode('victron-input-tank', 'Tank Sensor', 'tank');
    registerInputNode('victron-input-temperature', 'Temperature Sensor', 'temperature');
    registerInputNode('victron-input-vebus', 'VE.Bus System', 'vebus');

    registerOutputNode('victron-output-accharger', 'AC Charger', 'accharger');
    registerOutputNode('victron-output-acsystem', 'AC System', 'acsystem');
    registerOutputNode('victron-output-battery', 'Battery Monitor', 'battery');
    registerOutputNode('victron-output-charger', 'Charger', 'charger');
    registerOutputNode('victron-output-dcdc', 'DC-DC', 'dcdc');
    registerOutputNode('victron-output-dess', 'Dynamic ESS', 'dess');
    registerOutputNode('victron-output-ess', 'ESS', 'ess');
    registerOutputNode('victron-output-evcharger', 'EV Charger', 'evcharger');
    registerOutputNode('victron-output-generator', 'GX Generator', 'generator');
    registerOutputNode('victron-output-inverter', 'Inverter', 'inverter');
    registerOutputNode('victron-output-multi', 'Multi RS', 'multi');
    registerOutputNode('victron-output-pump', 'Pump', 'pump');
    registerOutputNode('victron-output-pvinverter', 'PV Inverter', 'pvinverter');
    registerOutputNode('victron-output-relay', 'Relay', 'relay');
    registerOutputNode('victron-output-settings', 'Settings', 'settings');
    registerOutputNode('victron-output-solarcharger', 'Solar Charger', 'solarcharger');
    registerOutputNode('victron-output-switch', 'Switch', 'switch');
    registerOutputNode('victron-output-vebus', 'VE.Bus System', 'vebus');

    // Custom input and output nodes:
    registerNode('victron-input-custom', 'Custom Input', 'custom', false, true)
    registerNode('victron-output-custom', 'Custom', 'custom', true, true);

</script>
