
<script type="text/template" id="input-edit-template">
    <div class="victron-form">
        <div class="form-row" id="service-row">
            <label for="node-input-service">Device</label>
            <select id="node-input-service"></select>
        </div>
        <div class="form-info hidden" id="duplicatesinfo"></div>
        <div class="form-row" id="path-row">
            <label for="node-input-path">Measurement</label>
            <select id="node-input-path"></select>
        </div>
        <div class="form-warning hidden" id="warningmessage"></div>
        <div class="form-warning hidden" id="statusmessage"></div>
        <div class="form-tips hidden" id="enuminfo">
            <p class="enuminfo--header">Value types</p>
            <p id="enuminfo-text"></p>
        </div>
        <div class="form-row hidden" id="initial-row">
            <hr />
            <label for="node-input-initial">Initial value</label>
            <select id="node-input-initial"></select>
            <div class="info-text">
                The initial value is sent to the device whenever the node is deployed.
            </div>
        </div>
        <div class="form-row" id="name-row">
            <hr />
            <label for="node-input-name">Node label</label>
            <input type="text" id="node-input-name">
            <div class="info-text">
                <i>The node can be given an arbitrary label that is shown instead of device name and service.</i>
            </div>
        </div>
        <div class="hidden" id="outputinfo">
            <hr />
            <div class="info-text">
                The value for the controlled output should be set in incoming message's <code>msg.payload</code> property.
                Please refer to 'Value Types' box above for adjustable settings.</i>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
    /* Common functions */
    const serviceRoot = '/victron/services/';

    function buildEditPanel(node, serviceUrl, isOutputNode, nodeLabel) {
        let serviceElem = $('#node-input-service');
        let pathElem = $('#node-input-path');
        let initialValueElem = $('#node-input-initial');

        let serviceDataAvailable = null;

        const nodeLabelLower = nodeLabel.toLowerCase();

        const buildOption = service => {
            return $('<option/>')
                .val(service.service || service.path)
                .text(service.name)
                .data(service);
            }

        const populateSelect = (selector, services) => {
            selector[0].options.length = 0;
            services.forEach(service => {
                selector.append(buildOption(service));
            });
            selector.trigger('change')
        }

        const updatePaths = () => {
            const serviceData = serviceElem.find(':selected').data();
            if (serviceData && serviceData.paths)
                populateSelect(pathElem, serviceData.paths);
        }

        const updateEnums = () => {
            const pathData = pathElem.find(':selected').data()

            if (pathData) {
                pathData.warning && serviceDataAvailable
                    ? changeStatusText($('#warningmessage'), 'fa-exclamation-circle', pathData.warning)
                    : $('#warningmessage').hide();
            }

            if (pathData && pathData.type === 'enum') {
                const valueTypesEnum = pathData.enum
                showEnumInfo(valueTypesEnum)

                const selectOptions = Object.keys(valueTypesEnum).map(key => ({
                    service: key,
                    name: `${key} - ${valueTypesEnum[key]}`
                }))

                selectOptions.unshift({service: null, name: "Don't set initial value"})
                populateSelect(initialValueElem, selectOptions)

                if (node.initial)
                    initialValueElem.val(node.initial)

                if (isOutputNode)
                    $('#initial-row').show();

            } else {
                hideEnumInfo()
                // unset and hide initialValue
                $('#initial-row').hide();
                initialValueElem.val(null)
            }
        }

        const showStatusMessage = (msg) => {
            serviceElem.attr('disabled', 'disabled');
            pathElem.attr('disabled', 'disabled');
            initialValueElem.attr('disabled', 'disabled');
            changeStatusText($('#statusmessage'), 'fa-exclamation-circle', msg);

        }

        const changeStatusText = (selector, iconClass, message) => {
            // fa-info-circle fa-exclamation-circle
            selector.html(`<i class="fa ${iconClass} fa-2x"></i><i>${message}</i>`).show();
        }

        const showEnumInfo = (enumObj) => {
            const msg = Object.entries(enumObj).map((item, key) => {
                return `${item[0]} - ${item[1]}`
            }).join('<br/>')
            $('#enuminfo-text').html(msg);
            $('#enuminfo').show();
        }

        const hideEnumInfo = () => {
            $('#enuminfo').hide();
        }

        /*  If a node was previously deployed, update the edit based on the old data */
        const appendSavedService = (data) => {
            if (node.service) {
                // if the service not present anymore, still add it to the select list
                if (!data.find(s => s.service === node.service)) {
                    buildOption(node.serviceObj)
                        .text(node.serviceObj.name + " [disconnected]")
                        .appendTo(serviceElem);
                }
                serviceElem.val(node.service);
            }
        }

        // Upon receiving data, populate the edit form
        $.getJSON(serviceRoot + serviceUrl, function(data) {
            serviceDataAvailable = data.length;

            // in case any services are available, populate the service and path dropdowns
            if (data.length !== 0) {
                populateSelect(serviceElem, data);

                // check for duplicate options in order to show an info message on setting a custom name
                const hasDuplicateNames = (new Set(data.map(s => s.name))).size !== data.length;
                if (hasDuplicateNames) {
                    const msg = `Multiple ${nodeLabelLower}s were found with the same name. You can set a custom name for the device in Venus settings.`
                    changeStatusText($('#duplicatesinfo'), 'fa-info-circle', msg);
                }
            }
            else { // otherwise, disable inputs and show a pretty statusmessage
                node.serviceObj
                    ? showStatusMessage(`There are no ${nodeLabelLower}s available. Please check that the selected ${node.serviceObj.name} is properly connected.`)
                    : showStatusMessage(`There are no ${nodeLabelLower}s available. Please check that a ${nodeLabelLower} is connected or try a different node.`);
            }

            // append old service data, if we have a service and path saved to the node
            appendSavedService(data);

            // a change on serviceElem dropdown triggers updatePaths()
            // which renders new options for the selected service
            updatePaths();
            serviceElem.change(updatePaths);

            if (node.path)
                pathElem.val(node.path);

            // a change on pathElem dropdown triggers updateEnums()
            // which renders the enum value info box on demand
            updateEnums();
            pathElem.change(updateEnums);

            // show the information text on using 'msg.payload' to trigger settings for output nodes
            if (isOutputNode)
                $('#outputinfo').show();

        })
        .fail(() => showStatusMessage("Unable to access the service endpoint."));
    }

    function saveEditPanel(node) {
        // save the current service and path objects
        node.serviceObj = $('#node-input-service').find(':selected').data()
        node.pathObj = $('#node-input-path').find(':selected').data()
    }

    function buildNodeLabel(node, nodeName) {
        let altName = nodeName;
        if (node.serviceObj && node.path) {
            let svc = node.serviceObj.name;
            let path = node.serviceObj.paths.find(p => p.path === node.path).name;
            altName = `${svc} | ${path}`;
        }
        return node.name || altName
    }

    // Builds the edit panel form dynamically for each input node
    function buildEditForm(nodeType, serviceName) {
        // Clone the edit form template
        let editForm = $("#input-edit-template").clone().html()

        let scriptTag = $("<script>")
            .attr("type", "text/x-red")
            .attr("data-template-name", nodeType)
            .append(editForm)

        // Edit template data
        scriptTag.find('#service-row > label').text(serviceName)

        // Append to the document body
        $('body').append(scriptTag.prop('outerHTML'))
    }

    /* Node definitions */

    // Creates an input-node config and registers it with
    // the Node-RED Node API
    function registerNode(nodeType, nodeLabel, serviceType, isOutputNode) {
        // Copy the edit form template to the html body

        buildEditForm(nodeType, nodeLabel);
        const nodePaletteLabel = isOutputNode ? nodeLabel + ' Control' : nodeLabel;

        // Register a new node
        RED.nodes.registerType(nodeType, {
            category: 'Victron Energy',
            paletteLabel: nodePaletteLabel,
            defaults: {
                service: {value: ""},
                path: {value: ""},
                serviceObj: {value: undefined},
                pathObj: {value: undefined},
                initial: {value: undefined}, // only used for some output nodes
                name: {value: ""}
            },
            color: '#4790d0',
            inputs: (isOutputNode ? 1: 0),
            outputs: (isOutputNode ? 0: 1),
            icon: "victronenergy.svg",
            label: function() {
                return buildNodeLabel(this, nodePaletteLabel)
            },
            oneditprepare: function() {
                buildEditPanel(this, serviceType, isOutputNode, nodeLabel)
            },
            oneditsave: function() {
                saveEditPanel(this)
            }
        });
    }

    function registerInputNode(nodeType, nodeLabel, serviceType) {
        registerNode(nodeType, nodeLabel, serviceType, false)
    }

    function registerOutputNode(nodeType, nodeLabel, serviceType) {
        registerNode(nodeType, nodeLabel, serviceType, true)
    }

    // input nodes
    registerInputNode('victron-input-digitalinput', 'Digital Input', 'input-digitalinput')
    registerInputNode('victron-input-tank', 'Tank Sensor', 'input-tank')
    registerInputNode('victron-input-temperature', 'Temperature Sensor', 'input-temperature')
    registerInputNode('victron-input-inverter', 'Inverter', 'input-inverter')
    registerInputNode('victron-input-pvinverter', 'PV Inverter', 'input-pvinverter')
    registerInputNode('victron-input-accharger', 'AC Charger', 'input-accharger')
    registerInputNode('victron-input-solarcharger', 'Solar Charger', 'input-solarcharger')
    registerInputNode('victron-input-battery', 'Battery Monitor', 'input-battery')
    registerInputNode('victron-input-gridmeter', 'Grid Meter', 'input-gridmeter')
    registerInputNode('victron-input-vebus', 'VE.Bus System', 'input-vebus')

    // output nodes
    registerOutputNode('victron-output-relay', 'Relay', 'output-relay')
    registerOutputNode('victron-output-vebus', 'VE.Bus System', 'output-vebus')
    registerOutputNode('victron-output-inverter', 'Inverter', 'output-inverter')
    registerOutputNode('victron-output-accharger', 'AC Charger', 'output-accharger')
    registerOutputNode('victron-output-solarcharger', 'Solar Charger', 'output-solarcharger')

</script>

<style>
    .victron-form div {
        width: 450px;
    }
    .victron-form label, .enuminfo--header {
        font-weight: 500;
    }
    .victron-form input, select {
        width: 300px;
    }
    .victron-form .hidden {
        display: none;
    }
    .victron-form .form-tips {
        padding: 16px;
        margin-bottom: 12px;
        width: 410px;
    }
    .victron-form .form-warning, .form-info {
        padding-bottom: 8px;
        max-width: 450px;
    }
    .victron-form .form-info {
        font-style: italic;
        padding-bottom: 8px;
        max-width: 450px;
    }
    .victron-form .fa {
        float: left;
        margin: 5px 10px 0px 0px;
    }
    .victron-form .form-info .fa {
        color: #00BCFF;
    }
    .victron-form .form-warning .fa {
        color: #d6615f;
    }
    .victron-form .form-row label {
        min-width: 140px;
    }
    .victron-form .info-text {
        padding: 8px 0px;
        font-style: italic;
    }
    .victron-form .hr {
        margin: 8px 0;
    }
</style>
